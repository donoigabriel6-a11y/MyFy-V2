<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MyFy ‚Äì Music Player</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <!-- YouTube IFrame Player API -->
  <script src="https://www.youtube.com/iframe_api"></script>

  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.google.com/recaptcha/api.js" async defer></script>

  <style>
    :root {
      --bg-main: #050505;
      --bg-elevated: #181818;
      --bg-hover: #262626;
      --accent: #ff0000;
      --accent-soft: #f97316;
      --text-primary: #ffffff;
      --text-secondary: #b3b3b3;
      --border-subtle: #2a2a2a;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:"Inter",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:var(--bg-main);
      color:var(--text-primary);
      overflow:hidden;
    }
    .app{
      display:grid;
      grid-template-rows:auto 1fr auto;
      height:100vh;
      background:
        radial-gradient(circle at top left,#ff000020 0,transparent 55%),
        radial-gradient(circle at bottom right,#f9731620 0,transparent 55%),
        var(--bg-main);
    }
    header.top{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding:10px 18px;
      background:rgba(0,0,0,0.9);
      border-bottom:1px solid #000;
      backdrop-filter:blur(12px);
      z-index:20;
    }
    .logo-area{display:flex;align-items:center;gap:8px;}
    .logo-dot{
      width:30px;height:30px;border-radius:50%;
      background:radial-gradient(circle at 30% 30%,#ffb3b3,#ff0000);
      display:flex;align-items:center;justify-content:center;
      font-weight:800;font-size:18px;color:#000;
    }
    .brand{font-weight:700;letter-spacing:.08em;font-size:18px;}
    .nav-tabs{display:flex;gap:6px;background:#111;border-radius:999px;padding:3px;}
    .nav-tab{
      border:none;border-radius:999px;padding:6px 14px;
      font-size:13px;font-weight:500;background:transparent;
      color:var(--text-secondary);cursor:pointer;
    }
    .nav-tab.active{background:#fff;color:#111;}
    .top-right{display:flex;align-items:center;gap:8px;flex-wrap:wrap;justify-content:flex-end;}
    .welcome{font-size:13px;color:var(--text-secondary);}
    .pill{
      border-radius:999px;border:1px solid var(--border-subtle);
      background:transparent;color:var(--text-secondary);
      padding:6px 12px;font-size:12px;font-weight:500;
      cursor:pointer;
    }
    .pill.solid{background:var(--accent);border-color:var(--accent);color:#fff;}
    .search-bar{
      display:flex;align-items:center;gap:6px;
      background:#111;border-radius:999px;padding:3px 8px;
      border:1px solid var(--border-subtle);
    }
    .search-bar input{
      border:none;outline:none;background:transparent;color:#fff;
      font-size:13px;width:200px;
    }
    .search-bar input::placeholder{color:var(--text-secondary);}
    .layout{
      display:grid;
      grid-template-columns:minmax(0,3fr) minmax(260px,1.4fr);
      gap:16px;
      padding:14px 18px 18px;
      overflow:hidden;
    }
    @media(max-width:900px){
      .layout{grid-template-columns:1fr;grid-template-rows:auto auto;}
    }
    .main-pane{overflow-y:auto;padding-right:4px;}
    .side-pane{
      background:rgba(24,24,24,0.95);
      border-radius:10px;
      padding:10px 12px;
      border:1px solid #000;
      display:flex;flex-direction:column;gap:10px;
      overflow-y:auto;
    }
    .hero{margin-bottom:16px;}
    .hero h1{margin:0 0 4px;font-size:22px;font-weight:800;}
    .hero p{margin:0;font-size:13px;color:var(--text-secondary);max-width:520px;}
    .section-header{display:flex;justify-content:space-between;align-items:baseline;margin:6px 0 8px;}
    .section-header h2{margin:0;font-size:17px;font-weight:700;}
    .section-header span{font-size:12px;color:var(--text-secondary);}
    .tags{display:flex;flex-wrap:wrap;gap:8px;margin-top:10px;}
    .tag{font-size:11px;border-radius:999px;border:1px solid var(--border-subtle);padding:3px 9px;background:#111;color:var(--text-secondary);cursor:pointer;}
    .grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:12px;padding-bottom:40px;}
    .card{
      background:#181818;border-radius:10px;padding:9px;cursor:pointer;position:relative;overflow:hidden;
      transition:background .12s,transform .12s,box-shadow .12s;
    }
    .card:hover{background:#262626;transform:translateY(-2px);box-shadow:0 10px 24px rgba(0,0,0,.6);}
    .thumb{
      border-radius:8px;overflow:hidden;aspect-ratio:16/9;
      background:linear-gradient(135deg,#ff0000,#f97316,#a855f7);
      display:flex;align-items:center;justify-content:center;color:#fff;font-weight:700;font-size:20px;margin-bottom:6px;
    }
    .thumb img{width:100%;height:100%;object-fit:cover;display:block;}
    .card-title{font-size:14px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-bottom:2px;}
    .card-desc{font-size:12px;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .play-fab{
      position:absolute;right:12px;bottom:12px;width:34px;height:34px;border-radius:50%;
      background:var(--accent);display:flex;align-items:center;justify-content:center;
      box-shadow:0 8px 20px rgba(0,0,0,.7);opacity:0;transform:translateY(8px);transition:opacity .12s,transform .12s;
    }
    .card:hover .play-fab{opacity:1;transform:translateY(0);}
    .play-fab span{font-size:15px;}
    .lyrics-header{display:flex;justify-content:space-between;align-items:center;}
    .lyrics-header h3{margin:0;font-size:15px;font-weight:600;}
    .lyrics-meta{font-size:12px;color:var(--text-secondary);}
    .badge{font-size:11px;border-radius:999px;padding:2px 8px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.1);}
    .lyrics-body{
      margin-top:6px;padding:8px 10px;border-radius:8px;background:#050505;
      font-size:13px;line-height:1.5;max-height:280px;overflow-y:auto;white-space:pre-line;
    }
    footer.player{
      display:grid;grid-template-columns:260px 1fr 220px;align-items:center;
      gap:12px;padding:8px 16px;background:#181818;border-top:1px solid #000;
    }
    @media(max-width:900px){
      footer.player{grid-template-columns:1fr;grid-auto-rows:auto;}
    }
    .player-left{display:flex;align-items:center;gap:8px;min-width:0;}
    .player-thumb{width:48px;height:48px;border-radius:6px;background:#111;overflow:hidden;}
    .player-thumb img{width:100%;height:100%;object-fit:cover;}
    .player-meta{min-width:0;}
    .player-title{font-size:13px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .player-artist{font-size:12px;color:var(--text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .player-center{display:flex;flex-direction:column;align-items:center;gap:6px;}
    .controls{display:flex;align-items:center;gap:12px;}
    .ctrl{
      cursor:pointer;color:var(--text-secondary);font-size:18px;
    }
    .ctrl.play{
      width:30px;height:30px;border-radius:999px;background:var(--accent);
      display:flex;align-items:center;justify-content:center;color:#fff;font-size:15px;
      box-shadow:0 6px 18px rgba(0,0,0,.6);
    }
    .progress-row{display:flex;align-items:center;gap:8px;font-size:11px;color:var(--text-secondary);width:100%;max-width:520px;}
    .bar{flex:1;height:4px;border-radius:999px;background:#404040;position:relative;overflow:hidden;cursor:pointer;}
    .bar-fill{position:absolute;inset:0;width:0%;border-radius:999px;background:linear-gradient(90deg,var(--accent),var(--accent-soft));}
    .player-right{display:flex;align-items:center;justify-content:flex-end;gap:10px;flex-wrap:wrap;font-size:13px;color:var(--text-secondary);}
    .bar.small{width:90px;}
    .auth-overlay{
      position:fixed;inset:0;background:rgba(0,0,0,.9);
      display:flex;align-items:center;justify-content:center;z-index:40;
    }
    .auth-card{
      width:320px;max-width:90vw;background:#111;border-radius:14px;padding:18px;border:1px solid #333;
      box-shadow:0 18px 45px rgba(0,0,0,.85);
    }
    .auth-title{font-size:20px;font-weight:700;margin-bottom:4px;}
    .auth-sub{font-size:13px;color:var(--text-secondary);margin-bottom:10px;}
    .auth-switch{display:flex;gap:6px;background:#181818;border-radius:999px;padding:3px;margin-bottom:8px;}
    .auth-switch button{flex:1;border:none;border-radius:999px;padding:5px;font-size:12px;cursor:pointer;background:transparent;color:var(--text-secondary);}
    .auth-switch button.active{background:#fff;color:#000;}
    .auth-form{display:flex;flex-direction:column;gap:7px;}
    .auth-form label{font-size:12px;color:var(--text-secondary);}
    .auth-form input{border-radius:8px;border:1px solid #333;background:#181818;color:#fff;font-size:13px;padding:7px 9px;outline:none;}
    .auth-form input:focus{border-color:var(--accent-soft);}
    .auth-error{font-size:12px;color:#f97373;min-height:16px;}
    #ytPlayerWrapper{
      position:fixed;bottom:80px;left:20px;width:320px;height:0;opacity:0;pointer-events:none;transition:height .15s,opacity .15s;
    }
    #ytPlayerWrapper.show{height:180px;opacity:1;pointer-events:auto;}
  </style>
</head>
<body>
  <!-- Auth overlay -->
  <div class="auth-overlay" id="authOverlay">
    <div class="auth-card">
      <div class="auth-title">Sign in to MyFy</div>
      <div class="auth-sub">Use Google, GitHub, or email to save your library.</div>

      <div class="auth-switch">
        <button id="loginTab" class="active">Log in</button>
        <button id="signupTab">Sign up</button>
      </div>

      <div class="auth-form" id="authForm">
        <div style="display:flex;flex-direction:column;gap:6px;margin-bottom:4px;">
          <button type="button" class="pill" id="googleBtn">Continue with Google</button>
          <button type="button" class="pill" id="githubBtn">Continue with GitHub</button>
        </div>
        <div style="display:flex;align-items:center;gap:8px;font-size:11px;color:var(--text-secondary);margin:4px 0 2px;">
          <span style="flex:1;height:1px;background:#333;"></span>
          <span>or</span>
          <span style="flex:1;height:1px;background:#333;"></span>
        </div>
        <div style="margin:6px 0;">
          <div class="g-recaptcha" data-sitekey="6LfLlycsAAAAAEdkFenwNYtEMjva4rSvyUNJLJOF" data-callback="onCaptchaSuccess"></div>
        </div>
        <label>Email</label>
        <input type="text" id="authEmail" placeholder="you@example.com" />
        <label>Password</label>
        <input type="password" id="authPassword" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" />
        <div class="auth-error" id="authError"></div>
        <button type="button" class="pill solid" id="authSubmit">Continue</button>
      </div>
    </div>
  </div>

  <div class="app">
    <header class="top">
      <div class="logo-area">
        <div class="logo-dot">‚ñ∂</div>
        <div class="brand">MyFy</div>
      </div>

      <div class="nav-tabs">
        <button class="nav-tab active" data-tab="featured">Featured</button>
        <button class="nav-tab" data-tab="search">Search</button>
        <button class="nav-tab" data-tab="library">Library</button>
      </div>

      <div class="top-right">
        <form id="searchForm" class="search-bar" style="display:none;">
          <span>üîç</span>
          <input id="searchInput" type="text" placeholder="Search on YouTube‚Ä¶" />
          <button class="pill solid" type="submit">Search</button>
        </form>
        <span class="welcome" id="welcomeLabel">Welcome, guest</span>
        <button class="pill" id="logoutBtn" style="display:none;">Log out</button>
      </div>
    </header>

    <div class="layout">
      <main class="main-pane">
        <section id="featuredSection">
          <div class="hero">
            <h1>Featured tracks</h1>
            <p>Local MP3 files from your repo. Sign in, then click any card to play.</p>
          </div>
          <div class="section-header">
            <h2>Today‚Äôs picks</h2>
            <span>MP3s bundled with the site.</span>
          </div>
          <div class="grid" id="featuredGrid"></div>
        </section>

        <section id="searchSection" style="display:none;">
          <div class="hero">
            <h1>Search YouTube</h1>
            <p>Use the YouTube API to play full tracks in the official player.</p>
            <div class="tags">
              <button class="tag">lofi hip hop</button>
              <button class="tag">phonk</button>
              <button class="tag">gaming music</button>
              <button class="tag">d4vd</button>
              <button class="tag">crab rave</button>
            </div>
          </div>
          <div class="section-header">
            <h2>Results</h2>
            <span id="resultsSubtitle">Try a search or click a tag.</span>
          </div>
          <div class="grid" id="resultsGrid"></div>
        </section>

        <section id="librarySection" style="display:none;">
          <div class="hero">
            <h1>Your library</h1>
            <p>Songs you saved while listening. Stored per account in this browser.</p>
          </div>
          <div class="section-header">
            <h2>Saved tracks</h2>
            <span id="librarySubtitle">Sign in and save some tracks.</span>
          </div>
          <div class="grid" id="libraryGrid"></div>
        </section>
      </main>

      <aside class="side-pane">
        <div class="lyrics-header">
          <div>
            <h3>Lyrics & info</h3>
            <div class="lyrics-meta" id="lyricsMeta">Nothing playing yet.</div>
          </div>
          <span class="badge">beta</span>
        </div>
        <div class="lyrics-body" id="lyricsBody">
Pick a track and we‚Äôll show safe, non‚Äëcopyright info here plus a link to YouTube for full lyrics.
        </div>
      </aside>
    </div>

    <footer class="player">
      <div class="player-left">
        <div class="player-thumb" id="playerThumb"></div>
        <div class="player-meta">
          <div class="player-title" id="playerTitle">Nothing playing</div>
          <div class="player-artist" id="playerArtist">Sign in and choose a song</div>
        </div>
      </div>
      <div class="player-center">
        <div class="controls">
          <div class="ctrl" id="prevBtn">‚èÆ</div>
          <div class="ctrl play" id="playBtn">‚ñ∂</div>
          <div class="ctrl" id="nextBtn">‚è≠</div>
          <div class="ctrl" id="saveBtn">‚ô°</div>
        </div>
        <div class="progress-row">
          <span id="timeCurrent">0:00</span>
          <div class="bar" id="progressBar"><div class="bar-fill" id="progressFill"></div></div>
          <span id="timeTotal">0:00</span>
        </div>
      </div>
      <div class="player-right">
        <span>üîä</span>
        <div class="bar small" id="volumeBar"><div class="bar-fill" id="volumeFill" style="width:70%;"></div></div>
        <button class="pill" id="toggleVideoBtn">Show video</button>
        <span class="badge">YouTube + local MP3</span>
      </div>
    </footer>
  </div>

  <!-- Hidden YouTube player -->
  <div id="ytPlayerWrapper">
    <div id="ytPlayer"></div>
  </div>

  <script>
    // ---- Keys ----
    const YT_API_KEY = "AIzaSyCAI5uYDCGWGP_2NyUpkzTe4B-FzO0wmPo";
    const firebaseConfig = {
      apiKey: "AIzaSyCWQvsuaaNpNWSNr8PmI9IMt8dC7hyaxu8",
      authDomain: "my-fy-ac0eb.firebaseapp.com",
      projectId: "my-fy-ac0eb",
      storageBucket: "my-fy-ac0eb.appspot.com",
      messagingSenderId: "619474074736",
      appId: "1:619474074736:web:b56a4b08c0ad16342ec8b5",
      measurementId: "G-MLSMCVWS56"
    };
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();

    // ---- DOM ----
    const navTabs = document.querySelectorAll(".nav-tab");
    const featuredSection = document.getElementById("featuredSection");
    const searchSection = document.getElementById("searchSection");
    const librarySection = document.getElementById("librarySection");
    const searchForm = document.getElementById("searchForm");
    const searchInput = document.getElementById("searchInput");
    const tagButtons = document.querySelectorAll(".tag");
    const featuredGrid = document.getElementById("featuredGrid");
    const resultsGrid = document.getElementById("resultsGrid");
    const resultsSubtitle = document.getElementById("resultsSubtitle");
    const libraryGrid = document.getElementById("libraryGrid");
    const librarySubtitle = document.getElementById("librarySubtitle");
    const welcomeLabel = document.getElementById("welcomeLabel");
    const logoutBtn = document.getElementById("logoutBtn");

    const playerThumb = document.getElementById("playerThumb");
    const playerTitle = document.getElementById("playerTitle");
    const playerArtist = document.getElementById("playerArtist");
    const prevBtn = document.getElementById("prevBtn");
    const playBtn = document.getElementById("playBtn");
    const nextBtn = document.getElementById("nextBtn");
    const saveBtn = document.getElementById("saveBtn");
    const progressBar = document.getElementById("progressBar");
    const progressFill = document.getElementById("progressFill");
    const timeCurrent = document.getElementById("timeCurrent");
    const timeTotal = document.getElementById("timeTotal");
    const volumeBar = document.getElementById("volumeBar");
    const volumeFill = document.getElementById("volumeFill");
    const toggleVideoBtn = document.getElementById("toggleVideoBtn");
    const ytWrapper = document.getElementById("ytPlayerWrapper");

    const lyricsMeta = document.getElementById("lyricsMeta");
    const lyricsBody = document.getElementById("lyricsBody");

    const authOverlay = document.getElementById("authOverlay");
    const loginTab = document.getElementById("loginTab");
    const signupTab = document.getElementById("signupTab");
    const googleBtn = document.getElementById("googleBtn");
    const githubBtn = document.getElementById("githubBtn");
    const authEmail = document.getElementById("authEmail");
    const authPassword = document.getElementById("authPassword");
    const authError = document.getElementById("authError");
    const authSubmit = document.getElementById("authSubmit");

    // ---- Auth ----
    let authMode = "login"; // or "signup"
    let captchaVerified = false;

    function getDisplayName(user){
      if(!user) return "guest";
      if(user.displayName) return user.displayName;
      if(user.email) return user.email.split("@")[0];
      return "user";
    }
    function getLibraryKey(){
      const u = auth.currentUser;
      if(!u) return null;
      return "myfy_library_" + u.uid;
    }
    function loadLibrary(){
      const key = getLibraryKey();
      if(!key) return [];
      try{return JSON.parse(localStorage.getItem(key) || "[]");}catch{return [];}
    }
    function saveLibrary(list){
      const key = getLibraryKey();
      if(!key) return;
      localStorage.setItem(key, JSON.stringify(list));
    }

    loginTab.addEventListener("click",()=>{
      authMode="login";
      loginTab.classList.add("active");
      signupTab.classList.remove("active");
      authSubmit.textContent="Log in";
      authError.textContent="";
    });
    signupTab.addEventListener("click",()=>{
      authMode="signup";
      signupTab.classList.add("active");
      loginTab.classList.remove("active");
      authSubmit.textContent="Create account";
      authError.textContent="";
    });
    function onCaptchaSuccess() {
      captchaVerified = true;
      authError.textContent = "";
    }
    function resetCaptcha() {
      captchaVerified = false;
      if (typeof grecaptcha !== "undefined" && grecaptcha.reset) {
        grecaptcha.reset();
      }
    }
    window.onCaptchaSuccess = onCaptchaSuccess;


    function signInWithProvider(provider){
      if (!captchaVerified) {
        authError.textContent = "Please complete the reCAPTCHA first.";
        return;
      }
      auth.signInWithPopup(provider)
        .then(()=>{
          authError.textContent="";
          authOverlay.style.display="none";
        })
        .catch(err=>{
          console.error(err);
          authError.textContent = err.message || "Sign-in failed.";
        });
    }
    googleBtn.addEventListener("click",()=>{
      signInWithProvider(new firebase.auth.GoogleAuthProvider());
    });
    githubBtn.addEventListener("click",()=>{
      signInWithProvider(new firebase.auth.GithubAuthProvider());
    });

    authSubmit.addEventListener("click",()=>{
      if (!captchaVerified) {
        authError.textContent = "Please complete the reCAPTCHA first.";
        return;
      }
      const email = authEmail.value.trim();
      const pass  = authPassword.value.trim();
      if(!email || !pass){
        authError.textContent="Please fill in email and password.";
        return;
      }
      if(authMode==="signup"){
        auth.createUserWithEmailAndPassword(email,pass)
          .then(cred=>{
            const name=email.split("@")[0];
            cred.user.updateProfile({displayName:name}).catch(()=>{});
            authError.textContent="";
            authOverlay.style.display="none";
          })
          .catch(err=>{
            authError.textContent=err.message || "Could not create account.";
          });
      }else{
        auth.signInWithEmailAndPassword(email,pass)
          .then(()=>{
            authError.textContent="";
            authOverlay.style.display="none";
          })
          .catch(err=>{
            authError.textContent=err.message || "Sign-in failed.";
          });
      }
    });

    logoutBtn.addEventListener("click",()=>{ resetCaptcha(); auth.signOut(); });

    function requireAuth(){
      if (!captchaVerified) {
        authOverlay.style.display="flex";
        authError.textContent="Please complete the reCAPTCHA to continue.";
        return false;
      }
      if(!auth.currentUser){
        authOverlay.style.display="flex";
        authError.textContent="Please sign in to use the player.";
        return false;
      }
      return true;
    }

    auth.onAuthStateChanged(user=>{
      if(user){
        welcomeLabel.textContent = "Welcome, " + getDisplayName(user) + "!";
        logoutBtn.style.display="inline-flex";
        authOverlay.style.display="none";
      }else{
        welcomeLabel.textContent="Welcome, guest";
        logoutBtn.style.display="none";
        authOverlay.style.display="flex";
        resetCaptcha();
      }
      renderLibrary();
    });

    // ---- Tabs ----
    navTabs.forEach(btn=>{
      btn.addEventListener("click",()=>{
        const tab = btn.dataset.tab;
        navTabs.forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
        featuredSection.style.display = tab==="featured"?"":"none";
        searchSection.style.display   = tab==="search"  ?"":"none";
        librarySection.style.display  = tab==="library" ?"":"none";
        searchForm.style.display      = tab==="search"  ?"flex":"none";
      });
    });

    // ---- Tracks & Player ----
    const featuredTracks = [
      {
        id:"local-golden",
        kind:"local",
        src:"Golden By HUNTERX.mp3",
        title:"Golden",
        artist:"HUNTERX",
        thumb:null,
        videoId:"dQw4w9WgXcQ"
      },
      {
        id:"local-romantic",
        kind:"local",
        src:"d4vd - Romantic Homicide.mp3",
        title:"Romantic Homicide",
        artist:"d4vd",
        thumb:"https://i.ytimg.com/vi/tPEE9ZwTmy0/mqdefault.jpg",
        videoId:"tPEE9ZwTmy0"
      },
      {
        id:"local-feel-it",
        kind:"local",
        src:"d4vd - Feel It (Official Music Video).mp3",
        title:"Feel It",
        artist:"d4vd",
        thumb:null,
        videoId:"2nGsig_y3pA"
      },
      {
        id:"local-crab",
        kind:"local",
        src:"Crab Rave By Noisestorm.mp3",
        title:"Crab Rave",
        artist:"Noisestorm",
        thumb:"https://i.ytimg.com/vi/LDU_Txk06tM/mqdefault.jpg",
        videoId:"LDU_Txk06tM"
      },
      {
        id:"local-melly",
        kind:"local",
        src:"Melly Mike - Young Black & Rich (Official Music Video).mp3",
        title:"Young Black & Rich",
        artist:"Melly Mike",
        thumb:null,
        videoId:"QY6GqXc0w7E"
      }
    ];

    let currentList = [];
    let currentIndex = -1;
    let currentSource = null; // "local" or "yt"
    let progressTimer = null;
    const audioPlayer = new Audio();
    let ytPlayer = null;
    let videoVisible = false;

    function formatTime(sec){
      if(!sec||!isFinite(sec)) return "0:00";
      const m=Math.floor(sec/60);
      const s=Math.floor(sec%60);
      return m+":"+ (s<10?"0"+s:s);
    }
    function clearProgressTimer(){
      if(progressTimer){clearInterval(progressTimer);progressTimer=null;}
    }
    function startProgressTimer(){
      clearProgressTimer();
      progressTimer = setInterval(()=>{
        if(currentSource==="local"){
          if(!audioPlayer.duration) return;
          const t=audioPlayer.currentTime,d=audioPlayer.duration;
          progressFill.style.width=(t/d*100)+"%";
          timeCurrent.textContent=formatTime(t);
          timeTotal.textContent=formatTime(d);
        }else if(currentSource==="yt" && ytPlayer && typeof ytPlayer.getDuration==="function"){
          const d=ytPlayer.getDuration();
          if(!d||!isFinite(d)) return;
          const t=ytPlayer.getCurrentTime();
          progressFill.style.width=(t/d*100)+"%";
          timeCurrent.textContent=formatTime(t);
          timeTotal.textContent=formatTime(d);
        }
      },500);
    }

    audioPlayer.addEventListener("ended",()=>{
      clearProgressTimer();
      playNext();
    });

    function ensureYtPlayer(videoId){
      if(!videoId || !/^[a-zA-Z0-9_-]{11}$/.test(videoId)){
        alert("This track does not have a valid YouTube video id.");
        return false;
      }
      if(typeof YT === "undefined" || typeof YT.Player !== "function"){
        alert("The YouTube player script did not load. Make sure youtube.com works in this browser and that no extensions, DNS filters, or network rules are blocking YouTube.");
        return false;
      }
      if(!ytPlayer){
        ytPlayer = new YT.Player("ytPlayer",{
          videoId:videoId,
          playerVars:{autoplay:1,rel:0,modestbranding:1},
          events:{
            onReady:()=>{setVolume(.7);},
            onStateChange:(e)=>{
              if(e.data===YT.PlayerState.PLAYING){
                playBtn.textContent="‚è∏";
                startProgressTimer();
              }else if(e.data===YT.PlayerState.PAUSED){
                playBtn.textContent="‚ñ∂";
              }else if(e.data===YT.PlayerState.ENDED){
                clearProgressTimer();
                playNext();
              }
            }
          }
        });
      }else{
        ytPlayer.loadVideoById(videoId);
      }
      return true;
    }

    function updateNowPlaying(track){
      playerTitle.textContent = track.title;
      playerArtist.textContent = track.artist || "";
      if(track.thumb){
        playerThumb.innerHTML='<img src="'+track.thumb+'" alt="">';
      }else{
        playerThumb.innerHTML="";
      }
      const url = track.videoId ? "https://www.youtube.com/watch?v="+track.videoId : "https://www.youtube.com/";
      lyricsMeta.textContent = track.title + " ¬∑ " + (track.artist || "");
      lyricsBody.textContent =
`We can't show full lyrics here because of copyright.
Open the track on YouTube to see lyrics in the description or comments.

Title: ${track.title}
Artist: ${track.artist || "Unknown"}
YouTube: ${url}`;
    }

    function playFromIndex(index){
      if(index<0 || index>=currentList.length) return;
      const track = currentList[index];
      currentIndex=index;
      updateNowPlaying(track);

      // stop everything first
      audioPlayer.pause();
      if(ytPlayer && typeof ytPlayer.stopVideo==="function") ytPlayer.stopVideo();
      clearProgressTimer();
      progressFill.style.width="0%";
      timeCurrent.textContent="0:00";
      timeTotal.textContent="0:00";

      if(track.kind==="local"){
        currentSource="local";
        audioPlayer.src = track.src;
        audioPlayer.play().catch(err=>console.error(err));
        playBtn.textContent="‚è∏";
        startProgressTimer();
      }else{
        currentSource="yt";
        if(ensureYtPlayer(track.videoId)){
          playBtn.textContent="‚è∏";
          startProgressTimer();
        }
      }
    }

    function playNext(){
      if(!currentList.length) return;
      const next = (currentIndex+1) % currentList.length;
      playFromIndex(next);
    }
    function playPrev(){
      if(!currentList.length) return;
      const prev = (currentIndex-1+currentList.length)%currentList.length;
      playFromIndex(prev);
    }

    function togglePlay(){
      if(!requireAuth()) return;
      if(currentIndex===-1){
        if(!currentList.length){
          currentList = featuredTracks.slice();
        }
        playFromIndex(0);
        return;
      }
      if(currentSource==="local"){
        if(audioPlayer.paused){
          audioPlayer.play().catch(()=>{});
          playBtn.textContent="‚è∏";
          startProgressTimer();
        }else{
          audioPlayer.pause();
          playBtn.textContent="‚ñ∂";
          clearProgressTimer();
        }
      }else if(currentSource==="yt"){
        if(!ytPlayer){ playFromIndex(currentIndex); return; }
        try{
          const state = ytPlayer.getPlayerState ? ytPlayer.getPlayerState() : -1;
          if(state===YT.PlayerState.PLAYING){
            ytPlayer.pauseVideo();
            playBtn.textContent="‚ñ∂";
          }else{
            ytPlayer.playVideo();
            playBtn.textContent="‚è∏";
          }
        }catch(e){
          console.error(e);
          playFromIndex(currentIndex);
        }
      }
    }

    function setVolume(ratio){
      const v=Math.max(0,Math.min(1,ratio));
      volumeFill.style.width=(v*100)+"%";
      audioPlayer.volume=v;
      if(ytPlayer && typeof ytPlayer.setVolume==="function"){
        ytPlayer.setVolume(v*100);
      }
    }

    // ---- Render helpers ----
    function makeCard(track,index,listType){
      const card=document.createElement("article");
      card.className="card";
      const thumb=document.createElement("div");
      thumb.className="thumb";
      if(track.thumb){
        const img=document.createElement("img");
        img.src=track.thumb;
        img.alt=track.title;
        thumb.appendChild(img);
      }else{
        thumb.textContent=(track.title||"‚ô™").slice(0,2).toUpperCase();
      }
      const title=document.createElement("div");
      title.className="card-title";
      title.textContent=track.title;
      const desc=document.createElement("div");
      desc.className="card-desc";
      desc.textContent=track.artist || (track.kind==="local"?"Local file":"YouTube");
      const fab=document.createElement("div");
      fab.className="play-fab";
      fab.innerHTML="<span>‚ñ∂</span>";
      card.appendChild(thumb);
      card.appendChild(title);
      card.appendChild(desc);
      card.appendChild(fab);
      card.addEventListener("click",()=>{
        if(!requireAuth()) return;
        if(listType==="featured"){
          currentList = featuredTracks.slice();
        }else if(listType==="results"){
          // currentList already set
        }else if(listType==="library"){
          currentList = loadLibrary();
        }
        playFromIndex(index);
      });
      return card;
    }

    function renderFeatured(){
      featuredGrid.innerHTML="";
      featuredTracks.forEach((t,i)=>featuredGrid.appendChild(makeCard(t,i,"featured")));
    }

    function renderLibrary(){
      libraryGrid.innerHTML="";
      if(!auth.currentUser){
        librarySubtitle.textContent="You must sign in to see your library.";
        return;
      }
      const list = loadLibrary();
      if(!list.length){
        librarySubtitle.textContent="No tracks saved yet. Play something and hit ‚ô° to save it.";
        return;
      }
      librarySubtitle.textContent="You have "+list.length+" saved tracks.";
      list.forEach((t,i)=>libraryGrid.appendChild(makeCard(t,i,"library")));
    }

    function getCurrentLibrary(){ return loadLibrary(); }

    function saveCurrentTrack(){
      if(!requireAuth()) return;
      if(currentIndex===-1 || !currentList.length){
        alert("Play a track first, then you can save it.");
        return;
      }
      const lib = loadLibrary();
      const track = currentList[currentIndex];
      if(!lib.some(t=>t.id===track.id && t.kind===track.kind && t.src===track.src && t.videoId===track.videoId)){
        lib.push(track);
        saveLibrary(lib);
        renderLibrary();
        alert("Saved to your library.");
      }else{
        alert("Already in your library.");
      }
    }

    // ---- Search ----
    async function searchYouTube(term){
      if(!YT_API_KEY){
        alert("YouTube API key missing.");
        return;
      }
      resultsSubtitle.textContent="Searching YouTube‚Ä¶";
      resultsGrid.innerHTML="";
      try{
        const url = "https://www.googleapis.com/youtube/v3/search?part=snippet&type=video&maxResults=24&q="+encodeURIComponent(term)+"&key="+encodeURIComponent(YT_API_KEY);
        const res = await fetch(url);
        const data = await res.json();
        if(data.error){
          console.error(data.error);
          resultsSubtitle.textContent=data.error.message || "YouTube API error.";
          return;
        }
        const list=(data.items||[]).map(item=>({
          id:item.id.videoId,
          kind:"yt",
          videoId:item.id.videoId,
          title:item.snippet.title,
          artist:item.snippet.channelTitle,
          thumb:(item.snippet.thumbnails && (item.snippet.thumbnails.medium || item.snippet.thumbnails.default || {}).url) || null
        }));
        currentList = list;
        currentIndex=-1;
        if(!list.length){
          resultsSubtitle.textContent="No results. Try another search.";
          return;
        }
        resultsSubtitle.textContent="Found "+list.length+" results.";
        list.forEach((t,i)=>resultsGrid.appendChild(makeCard(t,i,"results")));
      }catch(e){
        console.error(e);
        resultsSubtitle.textContent="Network error talking to YouTube.";
      }
    }

    searchForm.addEventListener("submit",e=>{
      e.preventDefault();
      const term=searchInput.value.trim();
      if(!term) return;
      searchYouTube(term);
    });
    tagButtons.forEach(btn=>btn.addEventListener("click",()=>{
      const term=btn.textContent.trim();
      searchInput.value=term;
      searchYouTube(term);
      navTabs.forEach(b=>{if(b.dataset.tab==="search")b.click();});
    }));

    // ---- UI events ----
    playBtn.addEventListener("click",togglePlay);
    nextBtn.addEventListener("click",playNext);
    prevBtn.addEventListener("click",playPrev);
    saveBtn.addEventListener("click",saveCurrentTrack);

    progressBar.addEventListener("click",e=>{
      const rect=progressBar.getBoundingClientRect();
      const ratio=Math.max(0,Math.min(1,(e.clientX-rect.left)/rect.width));
      if(currentSource==="local"){
        if(audioPlayer.duration) audioPlayer.currentTime=audioPlayer.duration*ratio;
      }else if(currentSource==="yt" && ytPlayer && typeof ytPlayer.getDuration==="function"){
        const d=ytPlayer.getDuration();
        if(d&&isFinite(d)) ytPlayer.seekTo(d*ratio,true);
      }
    });

    volumeBar.addEventListener("click",e=>{
      const rect=volumeBar.getBoundingClientRect();
      const ratio=Math.max(0,Math.min(1,(e.clientX-rect.left)/rect.width));
      setVolume(ratio);
    });

    toggleVideoBtn.addEventListener("click",()=>{
      if(currentSource!=="yt" || !ytPlayer){
        alert("Only YouTube tracks have video.");
        return;
      }
      videoVisible=!videoVisible;
      if(videoVisible){
        ytWrapper.classList.add("show");
        toggleVideoBtn.textContent="Hide video";
      }else{
        ytWrapper.classList.remove("show");
        toggleVideoBtn.textContent="Show video";
      }
    });

    // ---- Init ----
    (function init(){
      renderFeatured();
      setVolume(0.7);
      lyricsMeta.textContent="Nothing playing yet.";
      lyricsBody.textContent="Pick a track to get started.";
    })();
  </script>
</body>
</html>
